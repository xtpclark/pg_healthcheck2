{
  "critical_topic_config_issues": {
    "metric_keywords": ["topic_configuration", "kafka"],
    "rules": [
      {
        "expression": "data.get('has_critical') == True and any(i.get('category') == 'min_isr' and 'BLOCK WRITES' in i.get('message', '') for i in data.get('issues', []))",
        "level": "critical",
        "score": 10,
        "reasoning": "Topic {data.get('topic')} has min.insync.replicas >= replication.factor. This BLOCKS ALL WRITES and causes service outage!",
        "recommendations": [
          "IMMEDIATE: Fix min.insync.replicas configuration",
          "min.insync.replicas must be < replication.factor",
          "Recommended: min.insync.replicas = replication.factor - 1",
          "This misconfiguration prevents producers from writing any data",
          "Fix immediately to restore write availability"
        ]
      },
      {
        "expression": "data.get('replication_factor', 0) == 1 and not data.get('topic', '').startswith('_')",
        "level": "critical",
        "score": 9,
        "reasoning": "Topic {data.get('topic')} has replication factor 1. NO FAULT TOLERANCE - broker failure causes data loss!",
        "recommendations": [
          "URGENT: Increase replication factor to at least 3",
          "Single-replica topics have no fault tolerance",
          "Broker failure will cause permanent data loss",
          "Use kafka-reassign-partitions tool to increase replication",
          "Plan maintenance window for replica addition"
        ]
      }
    ]
  },
  "topic_config_warnings": {
    "metric_keywords": ["topic_configuration"],
    "rules": [
      {
        "expression": "data.get('replication_factor', 0) == 2",
        "level": "high",
        "score": 7,
        "reasoning": "Topic {data.get('topic')} has replication factor 2. Limited fault tolerance - can only survive 1 broker failure.",
        "recommendations": [
          "Increase replication factor to 3 for production topics",
          "RF=2 provides minimal fault tolerance",
          "RF=3 is industry standard for production",
          "Balance durability requirements vs storage costs"
        ]
      },
      {
        "expression": "data.get('min_insync_replicas', 0) == 1 and data.get('replication_factor', 0) > 1",
        "level": "medium",
        "score": 5,
        "reasoning": "Topic {data.get('topic')} has low min.insync.replicas (1) for RF={data.get('replication_factor')}. Reduced durability.",
        "recommendations": [
          "Consider increasing min.insync.replicas to 2",
          "min.insync.replicas=1 allows ack from single replica",
          "Recommended: min.insync.replicas = 2 for RF=3",
          "Balance durability vs availability requirements"
        ]
      },
      {
        "expression": "any(i.get('category') == 'retention' and 'Long retention' in i.get('message', '') for i in data.get('issues', []))",
        "level": "medium",
        "score": 4,
        "reasoning": "Topic {data.get('topic')} has long retention period: {data.get('retention_formatted')}. May increase storage costs.",
        "recommendations": [
          "Review retention requirements for this topic",
          "Long retention increases disk usage and costs",
          "Consider if historical data could be archived elsewhere",
          "Balance retention needs vs storage capacity"
        ]
      }
    ]
  },
  "topic_config_optimization": {
    "metric_keywords": ["topic_configuration"],
    "rules": [
      {
        "expression": "data.get('compression_type') in ['producer', 'uncompressed']",
        "level": "low",
        "score": 3,
        "reasoning": "Topic {data.get('topic')} has no broker-side compression. Missing opportunity to save disk and bandwidth.",
        "recommendations": [
          "Consider enabling broker-side compression",
          "Recommended: lz4 or snappy for good balance",
          "zstd provides best compression ratio",
          "Compression reduces disk usage and network transfer",
          "Test compression impact on your specific workload"
        ]
      },
      {
        "expression": "data.get('segment_mb', 1024) < 512",
        "level": "low",
        "score": 3,
        "reasoning": "Topic {data.get('topic')} has small segment size: {data.get('segment_mb')}MB. May cause excessive file handles.",
        "recommendations": [
          "Consider increasing segment.bytes to 512MB-1GB",
          "Small segments create more files",
          "More files consume file descriptors",
          "Balance against retention and compaction requirements"
        ]
      }
    ]
  },
  "multiple_topics_with_issues": {
    "metric_keywords": ["topic_configuration"],
    "rules": [
      {
        "expression": "len(all_structured_findings.get('check_topic_configuration', {}).get('topic_configuration', {}).get('critical_topics', [])) >= 3",
        "level": "critical",
        "score": 10,
        "reasoning": "Multiple topics ({len(all_structured_findings.get('check_topic_configuration', {}).get('topic_configuration', {}).get('critical_topics', []))}) have critical configuration issues. Cluster-wide config audit needed.",
        "recommendations": [
          "URGENT: Perform cluster-wide topic configuration audit",
          "Multiple topics with critical issues indicate systemic problems",
          "Review topic creation process and templates",
          "Implement topic configuration standards and validation",
          "Use centralized topic management tooling",
          "Document and enforce configuration policies"
        ]
      },
      {
        "expression": "len(all_structured_findings.get('check_topic_configuration', {}).get('topic_configuration', {}).get('warning_topics', [])) >= 5",
        "level": "high",
        "score": 7,
        "reasoning": "Many topics ({len(all_structured_findings.get('check_topic_configuration', {}).get('topic_configuration', {}).get('warning_topics', []))}) have configuration warnings. Standardization needed.",
        "recommendations": [
          "Standardize topic configurations across cluster",
          "Create topic configuration templates",
          "Review and update broker default settings",
          "Implement configuration management automation",
          "Document rationale for non-standard configs"
        ]
      }
    ]
  },
  "cluster_config_health": {
    "metric_keywords": ["topic_configuration"],
    "data_conditions": [
      {"key": "topics_checked", "exists": true},
      {"key": "critical_count", "exists": true}
    ],
    "rules": [
      {
        "expression": "data.get('critical_count', 0) == 0 and data.get('warning_count', 0) == 0 and data.get('topics_checked', 0) > 0",
        "level": "info",
        "score": 0,
        "reasoning": "All {data.get('topics_checked')} topics follow configuration best practices. Excellent topic governance!",
        "recommendations": [
          "Maintain configuration standards as new topics are created",
          "Document configuration decisions for future reference",
          "Periodically review configs as requirements evolve"
        ]
      }
    ]
  }
}
