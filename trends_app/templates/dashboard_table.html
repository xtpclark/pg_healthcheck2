{% extends "base.html" %}

{% block title %}Dashboard - Health Check Trends{% endblock %}

{% block extra_head %}
<style>
    /* Sticky action bar animation */
    #action-bar {
        transition: transform 0.2s ease-in-out;
    }
    #action-bar.show {
        transform: translateY(0);
    }

    /* Table row selection highlight */
    tr.selected {
        background-color: #dbeafe !important;
    }

    /* Sortable column headers */
    th.sortable {
        cursor: pointer;
        user-select: none;
    }
    th.sortable:hover {
        background-color: #e2e8f0;
    }
    th.sortable .sort-icon {
        opacity: 0.3;
        transition: opacity 0.2s;
    }
    th.sortable:hover .sort-icon,
    th.sortable.active .sort-icon {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <!-- Filter Bar (Consistent with Analysis Screens) -->
    <div class="bg-white border border-slate-200 rounded shadow-sm mb-4">
        <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">Filters</h2>
            <div class="flex gap-2">
                <button id="save-filter-btn" class="text-xs text-blue-600 hover:text-blue-800">
                    üíæ Save Filter
                </button>
                <button id="load-filter-btn" class="text-xs text-slate-600 hover:text-slate-900">
                    üìÅ Load Filter
                </button>
            </div>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3">
                <!-- Company Filter -->
                <div>
                    <label for="company-filter" class="block text-xs font-medium text-slate-700 mb-1.5">Company</label>
                    <select id="company-filter" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Companies</option>
                    </select>
                </div>

                <!-- Target Filter -->
                <div>
                    <label for="target-filter" class="block text-xs font-medium text-slate-700 mb-1.5">Target System</label>
                    <select id="target-filter" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Targets</option>
                        {% for target in unique_targets %}
                        <option value="{{ target }}">{{ target }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Technology Filter -->
                <div>
                    <label for="technology-filter" class="block text-xs font-medium text-slate-700 mb-1.5">Technology</label>
                    <select id="technology-filter" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Technologies</option>
                        {% for tech in technologies %}
                        <option value="{{ tech.code }}">{{ tech.description }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Status Filter -->
                <div>
                    <label for="status-filter" class="block text-xs font-medium text-slate-700 mb-1.5">Status</label>
                    <select id="status-filter" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Runs</option>
                        <option value="favorites">‚≠ê Favorites Only</option>
                        <option value="critical">üî¥ With Critical Issues</option>
                        <option value="warnings">üü° With Warnings</option>
                        <option value="healthy">‚úì Healthy Only</option>
                    </select>
                </div>

                <!-- Time Range Preset -->
                <div>
                    <label for="timerange-filter" class="block text-xs font-medium text-slate-700 mb-1.5">Time Range</label>
                    <select id="timerange-filter" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="7d">Last 7 days</option>
                        <option value="30d" selected>Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                        <option value="180d">Last 6 months</option>
                        <option value="365d">Last year</option>
                        <option value="custom">Custom Range...</option>
                    </select>
                </div>

                <!-- Search -->
                <div>
                    <label for="search-filter" class="block text-xs font-medium text-slate-700 mb-1.5">Search</label>
                    <input type="text" id="search-filter" placeholder="Search runs..." class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Custom Date Range (Hidden Initially) -->
            <div id="custom-dates" class="hidden mt-3 grid grid-cols-2 gap-3">
                <div>
                    <label for="start-date" class="block text-xs font-medium text-slate-700 mb-1.5">Start Date</label>
                    <input type="date" id="start-date" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="end-date" class="block text-xs font-medium text-slate-700 mb-1.5">End Date</label>
                    <input type="date" id="end-date" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Bar (Like Executive Pipeline) -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
        <div class="bg-white border border-slate-200 p-4 rounded shadow-sm">
            <div class="text-2xl font-bold text-slate-900" id="stat-total">0</div>
            <div class="text-xs text-slate-600 mt-1">Total Runs</div>
        </div>
        <div class="bg-green-50 border border-green-200 p-4 rounded shadow-sm">
            <div class="text-2xl font-bold text-green-900" id="stat-healthy">0</div>
            <div class="text-xs text-green-700 mt-1">Healthy</div>
        </div>
        <div class="bg-orange-50 border border-orange-200 p-4 rounded shadow-sm">
            <div class="text-2xl font-bold text-orange-900" id="stat-warnings">0</div>
            <div class="text-xs text-orange-700 mt-1">Warnings</div>
        </div>
        <div class="bg-red-50 border border-red-200 p-4 rounded shadow-sm">
            <div class="text-2xl font-bold text-red-900" id="stat-critical">0</div>
            <div class="text-xs text-red-700 mt-1">Critical Issues</div>
        </div>
    </div>

    <!-- Main Table -->
    <div class="bg-white border border-slate-200 rounded shadow-sm">
        <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
            <h2 class="text-sm font-semibold text-slate-900">Health Check Runs</h2>
            <div class="text-xs text-slate-600">
                <span id="selected-count">0</span> selected | <span id="visible-count">0</span> visible
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full table-fixed divide-y divide-slate-200" id="runs-table">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="w-10 px-4 py-3">
                            <input type="checkbox" id="select-all" class="rounded border-slate-300">
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase sortable active" data-sort="timestamp">
                            Timestamp
                            <span class="sort-icon">‚Üì</span>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase sortable" data-sort="company">
                            Company
                            <span class="sort-icon">‚Üï</span>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase sortable" data-sort="target">
                            Target
                            <span class="sort-icon">‚Üï</span>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase sortable" data-sort="technology">
                            Technology
                            <span class="sort-icon">‚Üï</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-700 uppercase sortable" data-sort="status">
                            Status
                            <span class="sort-icon">‚Üï</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-700 uppercase">
                            Issues
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-700 uppercase">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-100" id="runs-tbody">
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-sm text-slate-500">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <div class="mt-2">Loading runs...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="px-4 py-3 border-t border-slate-200 flex items-center justify-between">
            <div class="text-xs text-slate-600">
                Showing <span id="page-start">0</span>-<span id="page-end">0</span> of <span id="total-runs">0</span> runs
            </div>
            <div class="flex gap-1" id="pagination-controls">
                <!-- Pagination buttons will be inserted here -->
            </div>
        </div>
    </div>

</div>

<!-- Sticky Action Bar (Shows when items selected) -->
<div id="action-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-blue-500 shadow-2xl z-50 hidden">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="text-sm text-slate-700">
            <span class="font-medium text-blue-700" id="action-bar-count">0</span> runs selected
        </div>
        <div class="flex gap-2">
            <button id="compare-selected-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Compare Selected
            </button>
            {% if current_user.has_privilege('GenerateReports') %}
            <button id="generate-ai-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Generate AI Report
            </button>
            {% endif %}
            {% if current_user.has_privilege('DeleteReports') %}
            <button id="bulk-delete-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Delete Selected
            </button>
            {% endif %}
            {% if current_user.has_privilege('DeleteReports') %}
            <button id="toggle-deleted-btn" class="px-4 py-2 bg-amber-100 hover:bg-amber-200 text-amber-900 text-sm font-medium rounded shadow-sm transition-colors border border-amber-300">
                <span id="toggle-deleted-text">Show Deleted</span>
            </button>
            {% endif %}
            <button id="bulk-action-btn" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white text-sm font-medium rounded shadow-sm transition-colors">
                More Actions ‚ñæ
            </button>
            <button id="clear-selection-btn" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded transition-colors">
                Clear Selection
            </button>
        </div>
    </div>
</div>

<!-- Save Filter Modal -->
<div id="save-filter-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white border border-slate-300 shadow-xl w-full max-w-md mx-4 rounded">
        <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-semibold text-slate-900">Save Filter Preset</h3>
            <button onclick="document.getElementById('save-filter-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">√ó</button>
        </div>
        <div class="p-4">
            <label for="filter-name-input" class="block text-xs font-medium text-slate-700 mb-1.5">Filter Name</label>
            <input type="text" id="filter-name-input" placeholder="e.g., Kafka Production Issues" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="px-4 py-3 bg-slate-50 border-t border-slate-200 flex justify-end gap-2">
            <button onclick="document.getElementById('save-filter-modal').classList.add('hidden')" class="px-3 py-1.5 text-sm text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50">
                Cancel
            </button>
            <button id="confirm-save-filter-btn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded">
                Save Filter
            </button>
        </div>
    </div>
</div>

<!-- Load Filter Modal -->
<div id="load-filter-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white border border-slate-300 shadow-xl w-full max-w-md mx-4 rounded">
        <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-semibold text-slate-900">Load Filter Preset</h3>
            <button id="close-load-filter-x" class="text-slate-400 hover:text-slate-600 text-xl">&times;</button>
        </div>
        <div class="p-4">
            <label for="filter-list-select" class="block text-xs font-medium text-slate-700 mb-1.5">Select a saved filter</label>
            <select id="filter-list-select" size="8" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <!-- Options populated by JavaScript -->
            </select>
            <p class="mt-2 text-xs text-slate-500">
                Double-click a filter to load it, or select and click Load
            </p>
        </div>
        <div class="px-4 py-3 bg-slate-50 border-t border-slate-200 flex justify-end gap-2">
            <button id="close-load-filter-cancel" class="px-3 py-1.5 text-sm text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50">
                Cancel
            </button>
            <button id="confirm-load-filter-btn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded">
                Load Filter
            </button>
        </div>
    </div>
</div>

<!-- AI Report Success Modal -->
<div id="ai-report-success-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white border border-slate-300 shadow-xl w-full max-w-md mx-4 rounded">
        <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between bg-green-50">
            <h3 class="text-sm font-semibold text-green-900">‚úÖ Report Generated Successfully</h3>
            <button id="close-success-modal-x" class="text-slate-400 hover:text-slate-600 text-xl">&times;</button>
        </div>
        <div class="p-4">
            <div class="mb-3">
                <p class="text-sm text-slate-700 mb-2">Your AI analysis report has been generated:</p>
                <div class="bg-slate-50 border border-slate-200 rounded p-3 text-xs">
                    <div class="mb-1"><strong>Report ID:</strong> <span id="success-report-id"></span></div>
                    <div><strong>Runs analyzed:</strong> <span id="success-runs-count"></span></div>
                </div>
            </div>
            <p class="text-sm text-slate-600">What would you like to do next?</p>
        </div>
        <div class="px-4 py-3 bg-slate-50 border-t border-slate-200 flex justify-end gap-2">
            <button id="success-view-history-btn" class="px-3 py-1.5 text-sm text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50">
                View Report History
            </button>
            <button id="success-download-btn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded">
                Download Report
            </button>
        </div>
    </div>
</div>

<!-- Generate AI Report Modal -->
<div id="generate-ai-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white border border-slate-300 shadow-xl w-full max-w-lg mx-4 rounded">
        <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-semibold text-slate-900">Generate AI Report</h3>
            <button id="close-ai-modal-x" class="text-slate-400 hover:text-slate-600 text-xl">&times;</button>
        </div>
        <div class="p-4">
            <!-- Summary -->
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                <div class="text-sm text-blue-900">
                    <span class="font-medium" id="modal-run-count">0</span> health check run(s) selected for analysis
                </div>
            </div>

            <!-- Token Estimate (Initially Hidden) -->
            <div id="token-estimate-section" class="hidden mb-4">
                <div class="p-3 border rounded" id="token-estimate-box">
                    <div class="text-xs font-medium text-slate-700 mb-2">Estimated Token Usage</div>
                    <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                        <div>
                            <span class="text-slate-600">Input:</span>
                            <span class="font-medium" id="token-input">0</span> tokens
                        </div>
                        <div>
                            <span class="text-slate-600">Output:</span>
                            <span class="font-medium" id="token-output">0</span> tokens
                        </div>
                        <div class="col-span-2">
                            <span class="text-slate-600">Total:</span>
                            <span class="font-medium" id="token-total">0</span> tokens
                        </div>
                    </div>
                    <div id="token-warnings"></div>
                    <div id="token-rate-limits">
                        <!-- Provider-specific rate limits populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- AI Profile Selection -->
            <div class="mb-4">
                <label for="ai-profile-select" class="block text-xs font-medium text-slate-700 mb-1.5">
                    AI Profile <span class="text-red-600">*</span>
                </label>
                <select id="ai-profile-select" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select AI Profile...</option>
                </select>
                <p class="mt-1 text-xs text-slate-500">
                    Choose which AI provider to use for analysis
                </p>
            </div>

            <!-- Analysis Style (Optional - defaults to quick analysis) -->
            <div class="mb-4">
                <label for="analysis-style-select" class="block text-xs font-medium text-slate-700 mb-1.5">
                    Analysis Style (Optional)
                </label>
                <select id="analysis-style-select" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="default">Quick Analysis (Default)</option>
                    <option value="technical">Technical Deep Dive</option>
                    <option value="executive">Executive Summary</option>
                    <option value="troubleshooting">Troubleshooting Guide</option>
                </select>
                <p class="mt-1 text-xs text-slate-500">
                    For formal reports with specific personas, use Trend Analysis instead
                </p>
            </div>

            <!-- Report Name -->
            <div class="mb-4">
                <label for="report-name-input" class="block text-xs font-medium text-slate-700 mb-1.5">
                    Report Name <span class="text-red-600">*</span>
                </label>
                <input
                    type="text"
                    id="report-name-input"
                    placeholder="e.g., Weekly PostgreSQL Analysis"
                    class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>

            <!-- Report Description (Optional) -->
            <div class="mb-4">
                <label for="report-description-input" class="block text-xs font-medium text-slate-700 mb-1.5">
                    Description (Optional)
                </label>
                <textarea
                    id="report-description-input"
                    rows="3"
                    placeholder="Add notes about this analysis..."
                    class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                ></textarea>
            </div>

            <!-- Loading State -->
            <div id="ai-modal-loading" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                <div class="flex items-center">
                    <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                    <span class="text-sm text-blue-900">Generating AI report...</span>
                </div>
            </div>

            <!-- Error State -->
            <div id="ai-modal-error" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded">
                <div class="text-sm text-red-900" id="ai-modal-error-message"></div>
            </div>
        </div>
        <div class="px-4 py-3 bg-slate-50 border-t border-slate-200 flex justify-between items-center">
            <div class="text-xs text-slate-600">
                <a href="/profile/ai-settings" class="text-blue-600 hover:text-blue-800">Manage AI Profiles</a>
            </div>
            <div class="flex gap-2">
                <button id="close-ai-modal-cancel" class="px-3 py-1.5 text-sm text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50">
                    Cancel
                </button>
                <button id="confirm-generate-ai-btn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded disabled:opacity-50 disabled:cursor-not-allowed">
                    Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// User privileges for action buttons
window.userPrivileges = {
    canEdit: {{ 'true' if current_user.has_privilege('EditReports') or current_user.has_privilege('EditAllTechnologyReports') else 'false' }},
    canEditPostgreSQL: {{ 'true' if current_user.has_privilege('EditPostgreSQLReports') else 'false' }},
    canEditKafka: {{ 'true' if current_user.has_privilege('EditKafkaReports') else 'false' }},
    canEditCassandra: {{ 'true' if current_user.has_privilege('EditCassandraReports') else 'false' }},
    canEditOpenSearch: {{ 'true' if current_user.has_privilege('EditOpenSearchReports') else 'false' }},
    canEditClickHouse: {{ 'true' if current_user.has_privilege('EditClickHouseReports') else 'false' }},
    canEditMongoDB: {{ 'true' if current_user.has_privilege('EditMongoDBReports') else 'false' }},
    canDownload: {{ 'true' if current_user.has_privilege('DownloadReports') else 'false' }},
    canDelete: {{ 'true' if current_user.has_privilege('DeleteReports') else 'false' }}
};
</script>
<script src="{{ url_for('static', filename='js/dashboard-table.js') }}?v=20251114-softdelete"></script>
{% endblock %}
