{% extends "base.html" %}

{% block title %}API Keys - Health Check Trends{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <!-- Filter Bar (Consistent with Dashboard) -->
    <div class="bg-white border border-slate-200 rounded shadow-sm mb-4">
        <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">Filters</h2>
            <button onclick="showGenerateModal()"
                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded shadow-sm transition-colors">
                + Generate New Key
            </button>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <!-- Company Filter -->
                {% if companies|length > 1 %}
                <div>
                    <label for="company-filter" class="block text-xs font-medium text-slate-700 mb-1.5">Company</label>
                    <select id="company-filter"
                            onchange="window.location.href='{{ url_for('api_keys.list_keys') }}' + (this.value ? '?company_id=' + this.value : '')"
                            class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Companies</option>
                        {% for company in companies %}
                        <option value="{{ company.id }}" {% if company.id == selected_company_id %}selected{% endif %}>
                            {{ company.company_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <!-- Key Type Filter -->
                <div>
                    <label for="type-filter" class="block text-xs font-medium text-slate-700 mb-1.5">Key Type</label>
                    <select id="type-filter" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Types</option>
                        <option value="customer">Customer</option>
                        <option value="trial">Trial</option>
                        <option value="internal">Internal</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div>
                    <label for="status-filter" class="block text-xs font-medium text-slate-700 mb-1.5">Status</label>
                    <select id="status-filter" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Keys</option>
                        <option value="active">Active</option>
                        <option value="revoked">Revoked</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>

                <!-- Search Filter -->
                <div>
                    <label for="search-filter" class="block text-xs font-medium text-slate-700 mb-1.5">Search</label>
                    <input type="text" id="search-filter" placeholder="Search by key name..."
                           class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Bar (Like Dashboard) -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
        <div class="bg-white border border-slate-200 p-4 rounded shadow-sm">
            <div class="text-2xl font-bold text-slate-900" id="total-keys">{{ keys|length }}</div>
            <div class="text-xs text-slate-600 mt-1">Total Keys</div>
        </div>
        <div class="bg-green-50 border border-green-200 p-4 rounded shadow-sm">
            <div class="text-2xl font-bold text-green-900" id="active-keys">
                {{ keys|selectattr('is_active')|rejectattr('is_expired')|list|length }}
            </div>
            <div class="text-xs text-green-700 mt-1">Active Keys</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 p-4 rounded shadow-sm">
            <div class="text-2xl font-bold text-blue-900" id="total-submissions">
                {{ keys|sum(attribute='submissions_last_30_days') or 0 }}
            </div>
            <div class="text-xs text-blue-700 mt-1">Submissions (30d)</div>
        </div>
        <div class="bg-slate-50 border border-slate-200 p-4 rounded shadow-sm">
            <div class="text-sm font-medium text-slate-900 mt-1" id="last-activity">
                {% set most_recent = keys|selectattr('last_used_at')|map(attribute='last_used_at')|max %}
                {% if most_recent %}
                {{ most_recent.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                <span class="text-slate-400">No activity</span>
                {% endif %}
            </div>
            <div class="text-xs text-slate-600 mt-1">Last Activity</div>
        </div>
    </div>

    <!-- Main Table -->
    <div class="bg-white border border-slate-200 rounded shadow-sm">
        <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
            <h2 class="text-sm font-semibold text-slate-900">API Keys</h2>
            <div class="text-xs text-slate-600" id="filtered-count">
                {{ keys|length }} keys
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full table-fixed divide-y divide-slate-200">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="w-1/5 px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase">
                            Key Name
                        </th>
                        <th class="w-16 px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase">
                            Type
                        </th>
                        <th class="w-20 px-4 py-3 text-center text-xs font-medium text-slate-700 uppercase">
                            Status
                        </th>
                        <th class="w-24 px-4 py-3 text-center text-xs font-medium text-slate-700 uppercase">
                            Usage (30d)
                        </th>
                        <th class="w-40 px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase">
                            Last Used
                        </th>
                        <th class="w-32 px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase">
                            Expires
                        </th>
                        <th class="w-32 px-4 py-3 text-center text-xs font-medium text-slate-700 uppercase">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-100" id="keys-table-body">
                    <!-- Rows populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="px-4 py-3 border-t border-slate-200 flex items-center justify-between">
            <div class="text-xs text-slate-600">
                Showing <span id="page-start">0</span>-<span id="page-end">0</span> of <span id="total-filtered">0</span> keys
            </div>
            <div class="flex gap-1" id="pagination-controls">
                <!-- Pagination buttons will be inserted here -->
            </div>
        </div>
    </div>

</div>

<!-- Generate Key Modal -->
<div id="generateModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white max-w-md w-full rounded shadow-xl">
            <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                <h3 class="text-base font-semibold text-slate-900">Generate New API Key</h3>
                <button onclick="hideGenerateModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="generateForm" onsubmit="generateKey(event)">
                <input type="hidden" name="company_id" value="{{ selected_company_id }}">

                <div class="px-6 py-4 space-y-4">
                    {% if companies|length > 1 %}
                    <div class="bg-blue-50 border border-blue-200 rounded p-3">
                        <p class="text-xs text-blue-800">
                            <strong>Company:</strong>
                            {% for company in companies %}
                                {% if company.id == selected_company_id %}{{ company.company_name }}{% endif %}
                            {% endfor %}
                        </p>
                    </div>
                    {% endif %}

                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1.5">
                            Key Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="key_name" required
                               class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="e.g., Production Server">
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1.5">
                            Key Type <span class="text-red-500">*</span>
                        </label>
                        <select name="key_type" id="key_type" required onchange="toggleTrialFields()"
                                class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {% for kt in key_types %}
                            <option value="{{ kt.key_type_code }}"
                                    data-allows-trial-limit="{{ kt.allows_trial_limit|lower }}"
                                    data-default-expiry="{{ kt.default_expiry_days or '' }}"
                                    title="{{ kt.key_type_description }}">
                                {{ kt.key_type_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <p id="key_type_description" class="text-xs text-slate-500 mt-1"></p>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1.5">
                            Expires In (days)
                        </label>
                        <input type="number" name="expires_days" min="1"
                               class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Leave blank to use default from key type">
                        <p class="text-xs text-slate-500 mt-1">Override the default expiration from the selected key type</p>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1.5">
                            Notes
                        </label>
                        <textarea name="notes" rows="3"
                                  class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Optional description"></textarea>
                    </div>
                </div>

                <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-2">
                    <button type="button" onclick="hideGenerateModal()"
                            class="px-4 py-2 border border-slate-300 text-slate-700 text-sm font-medium rounded hover:bg-slate-100 transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded shadow-sm transition-colors">
                        Generate Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Show Key Modal -->
<div id="showKeyModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white max-w-2xl w-full rounded shadow-xl">
            <div class="px-6 py-4 border-b border-slate-200">
                <h3 class="text-base font-semibold text-slate-900">API Key Generated Successfully!</h3>
                <p class="text-xs text-amber-600 mt-2 flex items-center">
                    <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    IMPORTANT: Save this key now. You will not be able to see it again!
                </p>
            </div>

            <div class="px-6 py-4 space-y-4">
                <div class="bg-slate-50 border border-slate-200 rounded p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium text-slate-600 uppercase">API Key</span>
                        <button onclick="copyApiKey()" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                            Copy to Clipboard
                        </button>
                    </div>
                    <code id="generatedApiKey" class="block font-mono text-xs text-slate-900 break-all p-2 bg-white border border-slate-200 rounded"></code>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded p-4">
                    <p class="text-xs text-blue-800 font-medium mb-2">Configuration Example:</p>
                    <pre id="configExample" class="text-xs font-mono text-blue-900 overflow-x-auto">destination: api

api:
  endpoint_url: {{ request.url_root }}api/submit-health-check
  api_key: &lt;YOUR_API_KEY&gt;
  timeout: 30</pre>
                </div>
            </div>

            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end">
                <button onclick="hideShowKeyModal()"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded shadow-sm transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// All API keys data from server
const allKeys = {{ keys|tojson }};
const showCompanyColumn = {{ 'true' if not selected_company_id else 'false' }};

// State
let state = {
    filteredKeys: [...allKeys],
    currentPage: 1,
    pageSize: 20
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTableHeaders();
    applyFilters();
    setupFilterListeners();
});

// Update table headers based on company selection
function updateTableHeaders() {
    const thead = document.querySelector('thead tr');
    if (showCompanyColumn && !document.getElementById('company-header')) {
        // Insert company column after key name
        const companyHeader = document.createElement('th');
        companyHeader.id = 'company-header';
        companyHeader.className = 'w-32 px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase';
        companyHeader.textContent = 'Company';
        thead.insertBefore(companyHeader, thead.children[1]);
    } else if (!showCompanyColumn && document.getElementById('company-header')) {
        document.getElementById('company-header').remove();
    }
}

// Setup filter event listeners
function setupFilterListeners() {
    document.getElementById('type-filter').addEventListener('change', applyFilters);
    document.getElementById('status-filter').addEventListener('change', applyFilters);
    document.getElementById('search-filter').addEventListener('input', applyFilters);
}

// Apply all filters
function applyFilters() {
    const typeFilter = document.getElementById('type-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();

    state.filteredKeys = allKeys.filter(key => {
        // Type filter
        if (typeFilter && key.key_type !== typeFilter) return false;

        // Status filter
        if (statusFilter === 'active' && (!key.is_active || key.is_expired)) return false;
        if (statusFilter === 'revoked' && (key.is_active || key.is_expired)) return false;
        if (statusFilter === 'expired' && !key.is_expired) return false;

        // Search filter
        if (searchFilter && !key.key_name.toLowerCase().includes(searchFilter)) return false;

        return true;
    });

    state.currentPage = 1;
    updateStats();
    renderTable();
    renderPagination();
}

// Update stats cards
function updateStats() {
    const activeKeys = state.filteredKeys.filter(k => k.is_active && !k.is_expired).length;
    const totalSubmissions = state.filteredKeys.reduce((sum, k) => sum + (k.submissions_last_30_days || 0), 0);

    document.getElementById('total-keys').textContent = state.filteredKeys.length;
    document.getElementById('active-keys').textContent = activeKeys;
    document.getElementById('total-submissions').textContent = totalSubmissions;
    document.getElementById('filtered-count').textContent = `${state.filteredKeys.length} keys`;
}

// Render table rows
function renderTable() {
    const tbody = document.getElementById('keys-table-body');
    const start = (state.currentPage - 1) * state.pageSize;
    const end = start + state.pageSize;
    const pageKeys = state.filteredKeys.slice(start, end);

    if (pageKeys.length === 0) {
        const colspan = showCompanyColumn ? '8' : '7';
        tbody.innerHTML = `
            <tr>
                <td colspan="${colspan}" class="px-4 py-12 text-center">
                    <div class="text-slate-400">
                        <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                        <p class="mt-2 text-sm">No API keys match your filters</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = pageKeys.map(key => {
        const status = key.is_expired ? 'expired' : (key.is_active ? 'active' : 'revoked');
        const statusBadge = {
            expired: '<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded bg-red-100 text-red-800">Expired</span>',
            revoked: '<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded bg-yellow-100 text-yellow-800">Revoked</span>',
            active: '<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded bg-green-100 text-green-800">Active</span>'
        }[status];

        const typeBadge = key.key_type === 'trial'
            ? '<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded bg-purple-100 text-purple-800">TRIAL</span>'
            : '<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded bg-blue-100 text-blue-800">' + key.key_type.toUpperCase() + '</span>';

        const lastUsed = key.last_used_at
            ? new Date(key.last_used_at).toLocaleString('en-US', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'})
            : '<span class="text-slate-400">Never</span>';

        const expires = key.expires_at
            ? new Date(key.expires_at).toLocaleDateString('en-US', {year: 'numeric', month: '2-digit', day: '2-digit'})
            : '<span class="text-slate-400">Never</span>';

        const usageDisplay = key.key_type === 'trial' && key.trial_max_submissions
            ? `${key.submissions_last_30_days || 0} <span class="text-xs text-slate-500">/ ${key.trial_max_submissions}</span>`
            : (key.submissions_last_30_days || 0);

        // View/Details button
        let actionButtons = `<a href="/profile/api-keys/${key.key_id}/usage"
                               class="inline-flex items-center px-2 py-1 text-xs border border-blue-500 text-blue-700 hover:bg-blue-50 transition-colors"
                               title="View Usage Details">
                                <i class="bi bi-eye"></i>
                            </a>`;

        // Revoke/Activate button
        if (key.is_active && !key.is_expired) {
            actionButtons += `<button onclick="revokeKey(${key.key_id}, '${key.key_name.replace(/'/g, "\\'")}')"
                                      class="inline-flex items-center px-2 py-1 text-xs border border-red-500 text-red-700 hover:bg-red-50 transition-colors"
                                      title="Revoke Key">
                                    <i class="bi bi-x-circle"></i>
                                </button>`;
        } else if (!key.is_expired) {
            actionButtons += `<button onclick="activateKey(${key.key_id}, '${key.key_name.replace(/'/g, "\\'")}')"
                                      class="inline-flex items-center px-2 py-1 text-xs border border-green-500 text-green-700 hover:bg-green-50 transition-colors"
                                      title="Activate Key">
                                    <i class="bi bi-check-circle"></i>
                                </button>`;
        }

        const companyCell = showCompanyColumn
            ? `<td class="px-4 py-3 text-sm text-slate-600">${key.company_name || 'N/A'}</td>`
            : '';

        return `
            <tr class="hover:bg-slate-50 transition-colors">
                <td class="px-4 py-3">
                    <div class="text-sm font-medium text-slate-900">${key.key_name}</div>
                </td>
                ${companyCell}
                <td class="px-4 py-3">${typeBadge}</td>
                <td class="px-4 py-3 text-center">${statusBadge}</td>
                <td class="px-4 py-3 text-center text-sm text-slate-900">${usageDisplay}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${lastUsed}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${expires}</td>
                <td class="px-4 py-3 text-center">
                    <div class="flex items-center justify-center gap-2">${actionButtons}</div>
                </td>
            </tr>
        `;
    }).join('');

    // Update pagination info
    const actualStart = start + 1;
    const actualEnd = Math.min(end, state.filteredKeys.length);
    document.getElementById('page-start').textContent = actualStart;
    document.getElementById('page-end').textContent = actualEnd;
    document.getElementById('total-filtered').textContent = state.filteredKeys.length;
}

// Render pagination controls
function renderPagination() {
    const totalPages = Math.ceil(state.filteredKeys.length / state.pageSize);
    const controls = document.getElementById('pagination-controls');

    if (totalPages <= 1) {
        controls.innerHTML = '';
        return;
    }

    let html = `
        <button class="px-3 py-1 text-sm border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                ${state.currentPage === 1 ? 'disabled' : ''}
                onclick="goToPage(${state.currentPage - 1})">
            ‹ Previous
        </button>
    `;

    const maxPages = 7;
    let startPage = Math.max(1, state.currentPage - Math.floor(maxPages / 2));
    let endPage = Math.min(totalPages, startPage + maxPages - 1);

    if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
    }

    if (startPage > 1) {
        html += `<button class="px-3 py-1 text-sm border border-slate-300 rounded hover:bg-slate-50" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) html += `<span class="px-2 text-slate-400">...</span>`;
    }

    for (let i = startPage; i <= endPage; i++) {
        html += `
            <button class="px-3 py-1 text-sm border border-slate-300 rounded ${i === state.currentPage ? 'bg-blue-600 text-white' : 'hover:bg-slate-50'}"
                    onclick="goToPage(${i})">${i}</button>
        `;
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += `<span class="px-2 text-slate-400">...</span>`;
        html += `<button class="px-3 py-1 text-sm border border-slate-300 rounded hover:bg-slate-50" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }

    html += `
        <button class="px-3 py-1 text-sm border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                ${state.currentPage === totalPages ? 'disabled' : ''}
                onclick="goToPage(${state.currentPage + 1})">
            Next ›
        </button>
    `;

    controls.innerHTML = html;
}

// Go to specific page
function goToPage(page) {
    state.currentPage = page;
    renderTable();
    renderPagination();
}

// Modal functions
function showGenerateModal() {
    document.getElementById('generateModal').classList.remove('hidden');
    // Initialize fields based on selected key type
    toggleTrialFields();
}

function hideGenerateModal() {
    document.getElementById('generateModal').classList.add('hidden');
    document.getElementById('generateForm').reset();
}

function toggleTrialFields() {
    const select = document.getElementById('key_type');
    const selectedOption = select.options[select.selectedIndex];
    const descriptionEl = document.getElementById('key_type_description');
    const expiryInput = document.querySelector('input[name="expires_days"]');

    // Show description
    descriptionEl.textContent = selectedOption.title;

    // Set default expiry placeholder if specified
    const defaultExpiry = selectedOption.getAttribute('data-default-expiry');
    if (defaultExpiry) {
        expiryInput.placeholder = `Leave blank to use default (${defaultExpiry} days)`;
    } else {
        expiryInput.placeholder = 'Leave blank for no expiration';
    }
}

function hideShowKeyModal() {
    document.getElementById('showKeyModal').classList.add('hidden');
    location.reload();
}

// Generate key
async function generateKey(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    try {
        const response = await fetch('{{ url_for("api_keys.generate_key") }}', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            hideGenerateModal();
            // Update the API key display
            document.getElementById('generatedApiKey').textContent = data.api_key;

            // Update the configuration example with the actual key
            const configExample = document.getElementById('configExample');
            const configText = `destination: api

api:
  endpoint_url: {{ request.url_root }}api/submit-health-check
  api_key: ${data.api_key}
  timeout: 30`;
            configExample.textContent = configText;

            document.getElementById('showKeyModal').classList.remove('hidden');
        } else {
            alert('Error: ' + (data.error || 'Failed to generate key'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Revoke key
async function revokeKey(keyId, keyName) {
    if (!confirm(`Are you sure you want to revoke the key "${keyName}"? This action will immediately disable the key.`)) {
        return;
    }

    const url = `/profile/api-keys/${keyId}/revoke`;
    console.log('Revoking key at URL:', url);

    try {
        const response = await fetch(url, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to revoke key'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Activate key
async function activateKey(keyId, keyName) {
    if (!confirm(`Are you sure you want to activate the key "${keyName}"?`)) {
        return;
    }

    try {
        const response = await fetch(`/profile/api-keys/${keyId}/activate`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to activate key'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Copy API key to clipboard
function copyApiKey() {
    const apiKey = document.getElementById('generatedApiKey').textContent;
    navigator.clipboard.writeText(apiKey).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = originalText, 2000);
    });
}
</script>
{% endblock %}
