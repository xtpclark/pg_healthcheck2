{% extends "base.html" %}

{% block title %}Manage API Key Types - Health Check Trends{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-semibold text-slate-900">Admin: API Key Types</h2>
    <div class="flex gap-2">
        <a href="{{ url_for('main.dashboard') }}" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-colors">
            Back to Dashboard
        </a>
    </div>
</div>

<!-- Informational Banner -->
<div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
    <div class="flex items-start gap-2">
        <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div class="text-sm text-blue-900">
            <strong>API Key Type Management</strong>
            <p class="mt-1 text-blue-800">
                API key types control the behavior and constraints of generated API keys. Define custom types (customer, trial, internal, partner)
                with specific requirements like company association, trial limits, and default expiry periods.
            </p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
    <!-- Create Form -->
    <div class="lg:col-span-2">
        <div class="bg-white border border-slate-200">
            <div class="px-4 py-2.5 border-b border-slate-200 bg-slate-50">
                <h3 class="text-sm font-semibold text-slate-900">Create New API Key Type</h3>
            </div>
            <div class="p-4">
                <form action="{{ url_for('admin.create_api_key_type') }}" method="POST">
                    <div class="space-y-3">
                        <div>
                            <label for="code" class="block text-xs font-medium text-slate-700 mb-1">
                                Type Code <span class="text-red-600">*</span>
                            </label>
                            <input type="text" id="code" name="code" required
                                   placeholder="e.g., customer, trial, internal"
                                   pattern="[a-z0-9_]+"
                                   class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-slate-500 mt-1">Lowercase identifier (stored in api_keys.key_type)</p>
                        </div>
                        <div>
                            <label for="name" class="block text-xs font-medium text-slate-700 mb-1">
                                Display Name <span class="text-red-600">*</span>
                            </label>
                            <input type="text" id="name" name="name" required
                                   placeholder="e.g., Customer, Trial, Internal"
                                   class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-slate-500 mt-1">Human-readable name shown in UI dropdowns</p>
                        </div>
                        <div>
                            <label for="description" class="block text-xs font-medium text-slate-700 mb-1">
                                Description
                            </label>
                            <textarea id="description" name="description" rows="2"
                                      placeholder="e.g., Production keys for paying customers"
                                      class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            <p class="text-xs text-slate-500 mt-1">Shown in tooltips and documentation</p>
                        </div>
                        <div>
                            <label for="order_num" class="block text-xs font-medium text-slate-700 mb-1">
                                Display Order
                            </label>
                            <input type="number" id="order_num" name="order_num" min="1" value="999"
                                   class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-slate-500 mt-1">Lower numbers appear first (default: 999)</p>
                        </div>
                        <div>
                            <label for="default_expiry_days" class="block text-xs font-medium text-slate-700 mb-1">
                                Default Expiry Days
                            </label>
                            <input type="number" id="default_expiry_days" name="default_expiry_days" min="1"
                                   placeholder="Leave blank for no expiry"
                                   class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-slate-500 mt-1">Auto-fills expiry field when generating keys (optional)</p>
                        </div>
                        <div>
                            <label for="default_max_submissions" class="block text-xs font-medium text-slate-700 mb-1">
                                Total Submission Limit
                            </label>
                            <input type="number" id="default_max_submissions" name="default_max_submissions" min="1"
                                   placeholder="Leave blank for unlimited"
                                   class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-slate-500 mt-1">Maximum total submissions allowed (e.g., 3 for trial keys)</p>
                        </div>

                        <!-- Rate Limiting Section -->
                        <div class="border-t border-slate-200 pt-3 mt-1">
                            <h4 class="text-xs font-semibold text-slate-700 mb-2">Rate Limiting (Optional)</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="rate_limit_period" class="block text-xs font-medium text-slate-700 mb-1">
                                        Period
                                    </label>
                                    <select id="rate_limit_period" name="rate_limit_period"
                                            class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">None</option>
                                        <option value="hour">Hour</option>
                                        <option value="day">Day</option>
                                        <option value="week">Week</option>
                                        <option value="month">Month</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="rate_limit_count" class="block text-xs font-medium text-slate-700 mb-1">
                                        Max Per Period
                                    </label>
                                    <input type="number" id="rate_limit_count" name="rate_limit_count" min="1"
                                           placeholder="e.g., 1"
                                           class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">Limit submissions per time period (e.g., 1 per day). Both fields required if using rate limiting.</p>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="flex items-center gap-2 text-xs font-medium text-slate-700">
                                    <input type="checkbox" id="requires_company" name="requires_company" value="true" checked
                                           class="w-4 h-4 border-slate-300 text-blue-600 focus:ring-blue-500">
                                    <span>Requires Company</span>
                                </label>
                                <p class="text-xs text-slate-500 mt-1 ml-6">Keys must be linked to a company</p>
                            </div>
                            <div>
                                <label class="flex items-center gap-2 text-xs font-medium text-slate-700">
                                    <input type="checkbox" id="allows_trial_limit" name="allows_trial_limit" value="true"
                                           class="w-4 h-4 border-slate-300 text-blue-600 focus:ring-blue-500">
                                    <span>Allows Trial Limit</span>
                                </label>
                                <p class="text-xs text-slate-500 mt-1 ml-6">Can set max submission count</p>
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 text-xs font-medium text-slate-700">
                                <input type="checkbox" id="enabled" name="enabled" value="true" checked
                                       class="w-4 h-4 border-slate-300 text-blue-600 focus:ring-blue-500">
                                <span>Enabled (show in API key generation dropdown)</span>
                            </label>
                        </div>
                        <div>
                            <label for="notes" class="block text-xs font-medium text-slate-700 mb-1">
                                Notes (Optional)
                            </label>
                            <textarea id="notes" name="notes" rows="2"
                                      placeholder="e.g., Standard production API keys with no submission limits"
                                      class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            <p class="text-xs text-slate-500 mt-1">Internal documentation or usage notes</p>
                        </div>
                    </div>
                    <button type="submit" class="w-full mt-4 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-colors">
                        Create API Key Type
                    </button>
                </form>
            </div>
        </div>

        <!-- Reference Guide -->
        <div class="mt-4 bg-white border border-slate-200">
            <div class="px-4 py-2.5 border-b border-slate-200 bg-slate-50">
                <h3 class="text-sm font-semibold text-slate-900">Key Type Properties</h3>
            </div>
            <div class="p-4">
                <div class="space-y-2 text-xs text-slate-700">
                    <div>
                        <strong class="text-slate-900">Requires Company:</strong>
                        <p class="text-slate-500 mt-0.5">If enabled, API keys of this type must be associated with a company. Disable for trial keys that don't need company context.</p>
                    </div>
                    <div class="border-t border-slate-200 pt-2">
                        <strong class="text-slate-900">Allows Trial Limit:</strong>
                        <p class="text-slate-500 mt-0.5">If enabled, API keys of this type can have a max_submissions limit. Useful for trial keys with submission caps.</p>
                    </div>
                    <div class="border-t border-slate-200 pt-2">
                        <strong class="text-slate-900">Default Expiry Days:</strong>
                        <p class="text-slate-500 mt-0.5">Auto-fills the expiry days field when generating a key. For example, trial keys might default to 30 days, partner keys to 365 days.</p>
                    </div>
                    <div class="border-t border-slate-200 pt-2">
                        <strong class="text-slate-900">Total Submission Limit:</strong>
                        <p class="text-slate-500 mt-0.5">Maximum total submissions allowed over the key's lifetime. Leave blank for unlimited. Example: 3 for trial keys.</p>
                    </div>
                    <div class="border-t border-slate-200 pt-2">
                        <strong class="text-slate-900">Rate Limiting:</strong>
                        <p class="text-slate-500 mt-0.5">Limit submissions per time period to prevent abuse. Example: "1 per day" means users can submit once daily. Combines with total limit - e.g., "3 total, 1 per day" = submit once daily for 3 days.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Types Table -->
    <div class="lg:col-span-3">
        <div class="bg-white border border-slate-200">
            <div class="px-4 py-2.5 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                <h3 class="text-sm font-semibold text-slate-900">
                    Configured API Key Types
                    <span class="text-slate-500 font-normal">({{ key_types|length }} total)</span>
                </h3>
            </div>
            {% if key_types %}
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-2.5 text-left text-xs font-semibold text-slate-700">Code</th>
                            <th class="px-4 py-2.5 text-left text-xs font-semibold text-slate-700">Name</th>
                            <th class="px-4 py-2.5 text-center text-xs font-semibold text-slate-700">Order</th>
                            <th class="px-4 py-2.5 text-center text-xs font-semibold text-slate-700">Properties</th>
                            <th class="px-4 py-2.5 text-center text-xs font-semibold text-slate-700">Status</th>
                            <th class="px-4 py-2.5 text-center text-xs font-semibold text-slate-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
                        {% for kt in key_types %}
                        <tr class="hover:bg-slate-50" id="keytype-row-{{ kt.id }}">
                            <td class="px-4 py-2.5">
                                <code class="text-xs text-slate-900 font-mono">{{ kt.code }}</code>
                            </td>
                            <td class="px-4 py-2.5">
                                <div id="view-name-{{ kt.id }}" class="inline">
                                    <span class="text-sm font-medium text-slate-900">{{ kt.name }}</span>
                                    {% if kt.description %}
                                        <p class="text-xs text-slate-600 mt-0.5">{{ kt.description }}</p>
                                    {% endif %}
                                </div>
                                <!-- Edit form (hidden by default) -->
                                <form id="edit-form-{{ kt.id }}"
                                      action="{{ url_for('admin.update_api_key_type', key_type_id=kt.id) }}"
                                      method="POST"
                                      class="hidden flex flex-col gap-2 w-full">
                                    <input type="hidden" name="code" value="{{ kt.code }}">
                                    <input type="text"
                                           name="name"
                                           value="{{ kt.name }}"
                                           placeholder="Display Name"
                                           required
                                           class="w-full px-2 py-0.5 text-xs border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <textarea name="description"
                                              rows="2"
                                              placeholder="Description"
                                              class="w-full px-2 py-0.5 text-xs border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500">{{ kt.description or '' }}</textarea>
                                    <div class="flex gap-2 items-center">
                                        <button type="submit"
                                                class="px-2 py-0.5 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                            Save
                                        </button>
                                        <button type="button"
                                                onclick="toggleEdit({{ kt.id }}, false)"
                                                class="px-2 py-0.5 bg-slate-300 text-slate-700 text-xs rounded hover:bg-slate-400">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </td>
                            <td class="px-4 py-2.5 text-center">
                                <div id="view-order-{{ kt.id }}" class="inline">
                                    <span class="text-sm text-slate-700">{{ kt.order_num }}</span>
                                </div>
                                <!-- Edit order (hidden) -->
                                <div id="edit-order-{{ kt.id }}" class="hidden">
                                    <input type="number"
                                           form="edit-form-{{ kt.id }}"
                                           name="order_num"
                                           value="{{ kt.order_num }}"
                                           min="1"
                                           required
                                           class="w-20 px-2 py-0.5 text-xs border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                </div>
                            </td>
                            <td class="px-4 py-2.5">
                                <div id="view-props-{{ kt.id }}" class="inline">
                                    <div class="flex flex-wrap gap-1">
                                        {% if kt.requires_company %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" title="Requires company association">
                                                Company
                                            </span>
                                        {% endif %}
                                        {% if kt.allows_trial_limit %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800" title="Allows submission limits">
                                                Trial Limit
                                            </span>
                                        {% endif %}
                                        {% if kt.default_expiry_days %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800" title="Default expiry: {{ kt.default_expiry_days }} days">
                                                {{ kt.default_expiry_days }}d
                                            </span>
                                        {% endif %}
                                        {% if kt.default_max_submissions %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800" title="Total limit: {{ kt.default_max_submissions }} submissions">
                                                Max: {{ kt.default_max_submissions }}
                                            </span>
                                        {% endif %}
                                        {% if kt.rate_limit_period and kt.rate_limit_count %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-rose-100 text-rose-800" title="Rate limit: {{ kt.rate_limit_count }} per {{ kt.rate_limit_period }}">
                                                {{ kt.rate_limit_count }}/{{ kt.rate_limit_period }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <!-- Edit properties (hidden) -->
                                <div id="edit-props-{{ kt.id }}" class="hidden flex flex-col gap-1 text-xs">
                                    <label class="flex items-center gap-1">
                                        <input type="checkbox"
                                               form="edit-form-{{ kt.id }}"
                                               name="requires_company"
                                               value="true"
                                               {% if kt.requires_company %}checked{% endif %}
                                               class="w-3 h-3 border-slate-300 text-blue-600 focus:ring-blue-500">
                                        <span>Requires Company</span>
                                    </label>
                                    <label class="flex items-center gap-1">
                                        <input type="checkbox"
                                               form="edit-form-{{ kt.id }}"
                                               name="allows_trial_limit"
                                               value="true"
                                               {% if kt.allows_trial_limit %}checked{% endif %}
                                               class="w-3 h-3 border-slate-300 text-blue-600 focus:ring-blue-500">
                                        <span>Allows Trial Limit</span>
                                    </label>
                                    <input type="number"
                                           form="edit-form-{{ kt.id }}"
                                           name="default_expiry_days"
                                           value="{{ kt.default_expiry_days or '' }}"
                                           placeholder="Default expiry days"
                                           min="1"
                                           class="w-full px-2 py-0.5 text-xs border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500">

                                    <!-- Total Submission Limit -->
                                    <input type="number"
                                           form="edit-form-{{ kt.id }}"
                                           name="default_max_submissions"
                                           value="{{ kt.default_max_submissions or '' }}"
                                           placeholder="Total submission limit"
                                           min="1"
                                           class="w-full px-2 py-0.5 text-xs border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500">

                                    <!-- Rate Limiting Period -->
                                    <select form="edit-form-{{ kt.id }}"
                                            name="rate_limit_period"
                                            class="w-full px-2 py-0.5 text-xs border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">No rate limit</option>
                                        <option value="hour" {% if kt.rate_limit_period == 'hour' %}selected{% endif %}>Hour</option>
                                        <option value="day" {% if kt.rate_limit_period == 'day' %}selected{% endif %}>Day</option>
                                        <option value="week" {% if kt.rate_limit_period == 'week' %}selected{% endif %}>Week</option>
                                        <option value="month" {% if kt.rate_limit_period == 'month' %}selected{% endif %}>Month</option>
                                    </select>

                                    <!-- Rate Limiting Count -->
                                    <input type="number"
                                           form="edit-form-{{ kt.id }}"
                                           name="rate_limit_count"
                                           value="{{ kt.rate_limit_count or '' }}"
                                           placeholder="Max per period"
                                           min="1"
                                           class="w-full px-2 py-0.5 text-xs border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                </div>
                            </td>
                            <td class="px-4 py-2.5 text-center">
                                <div id="view-enabled-{{ kt.id }}" class="inline">
                                    {% if kt.enabled %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                            </svg>
                                            Enabled
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                            Disabled
                                        </span>
                                    {% endif %}
                                </div>
                                <!-- Edit enabled (hidden) -->
                                <div id="edit-enabled-{{ kt.id }}" class="hidden">
                                    <label class="flex items-center gap-1 text-xs">
                                        <input type="checkbox"
                                               form="edit-form-{{ kt.id }}"
                                               name="enabled"
                                               value="true"
                                               {% if kt.enabled %}checked{% endif %}
                                               class="w-4 h-4 border-slate-300 text-blue-600 focus:ring-blue-500">
                                        <span class="text-slate-700">Enabled</span>
                                    </label>
                                </div>
                            </td>
                            <td class="px-4 py-2.5 text-center">
                                <div class="inline-flex gap-1" id="actions-{{ kt.id }}">
                                    <button onclick="toggleEdit({{ kt.id }}, true)"
                                            class="inline-flex items-center px-2 py-1 text-xs border border-amber-500 text-amber-700 hover:bg-amber-50 transition-colors"
                                            title="Edit key type">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <form action="{{ url_for('admin.delete_api_key_type', key_type_id=kt.id) }}"
                                          method="POST"
                                          class="inline"
                                          onsubmit="return confirm('Delete API key type \'{{ kt.name }}\' ({{ kt.code }})? This will fail if any API keys are using this type.');">
                                        <button type="submit"
                                                class="inline-flex items-center px-2 py-1 text-xs border border-red-500 text-red-700 hover:bg-red-50 transition-colors"
                                                title="Delete key type">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-8 text-center text-slate-500">
                <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                </svg>
                <p class="mt-2 text-sm">No API key types configured yet. Create your first type to get started.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleEdit(keyTypeId, enable) {
    const viewName = document.getElementById(`view-name-${keyTypeId}`);
    const viewOrder = document.getElementById(`view-order-${keyTypeId}`);
    const viewProps = document.getElementById(`view-props-${keyTypeId}`);
    const viewEnabled = document.getElementById(`view-enabled-${keyTypeId}`);
    const editForm = document.getElementById(`edit-form-${keyTypeId}`);
    const editOrder = document.getElementById(`edit-order-${keyTypeId}`);
    const editProps = document.getElementById(`edit-props-${keyTypeId}`);
    const editEnabled = document.getElementById(`edit-enabled-${keyTypeId}`);
    const actions = document.getElementById(`actions-${keyTypeId}`);

    if (enable) {
        // Show edit form, hide view
        viewName.classList.add('hidden');
        viewOrder.classList.add('hidden');
        viewProps.classList.add('hidden');
        viewEnabled.classList.add('hidden');
        editForm.classList.remove('hidden');
        editOrder.classList.remove('hidden');
        editProps.classList.remove('hidden');
        editEnabled.classList.remove('hidden');
        actions.classList.add('hidden');

        // Focus the name input
        editForm.querySelector('input[name="name"]').focus();
    } else {
        // Show view, hide edit form
        viewName.classList.remove('hidden');
        viewOrder.classList.remove('hidden');
        viewProps.classList.remove('hidden');
        viewEnabled.classList.remove('hidden');
        editForm.classList.add('hidden');
        editOrder.classList.add('hidden');
        editProps.classList.add('hidden');
        editEnabled.classList.add('hidden');
        actions.classList.remove('hidden');
    }
}
</script>

{% endblock %}
